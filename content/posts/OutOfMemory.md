---
title: "记一次OOM的错误"
date: 2020-08-12T11:44:08+08:00
draft: true
---

###  背景故事

深圳阳光灿烂的一天，实习中的我在在进行功能开发时，有一个批量插入数据的需求：前端传参过来歌曲id列表，我这边后端将传来的歌曲插入到目标表中，插入到目标表前要根据歌曲id来补充相应的歌曲信息，如歌曲名字，歌手Id，歌手名字，版权方等等信息。



### 异常出现

在我看来是一个比较简单的需求，很快就完成了，把controller写好，接口发布出去，调用接口的时候出现了响应时间很慢，Chrome浏览器里显示该请求一直是在pending中，疑惑的我我查看日志发现，该请求报了`java.lang.OutOfMemoryError: Java heap space`的错误，我寻思着这是我第一次遇到OOM，兴奋起来了，我倒要看看到底是什么原因



### 原因分析

首先我们要分析java.lang.OutOfMemoryError出现的原因：

Java的自动内存管理依赖GC，GC会一遍又一遍地扫描内存区域, 将不使用的对象删除. 简单来说, **Java中的内存泄漏, 就是那些逻辑上不再使用的对象, 却没有被 [垃圾收集程序](http://blog.csdn.net/renfufei/article/details/54144385) 给干掉**. 从而导致垃圾对象继续占用堆内存中, 逐渐堆积, 最后造成 `java.lang.OutOfMemoryError:Java heap space` 错误。

那么具体表现为有如下两个原因：

1. 堆内存设置得太小了
2. 程序中出现了占用内存很多的大对象，无法被GC掉



首先排除原因1，因为我们这个项目一直都能很正常运行的，设置的堆内存也够大？首先更应该看下是不是代码写的有问题

我开始一行行看我写的代码，没看出啥问题







又转过去看日志，直到发现日志里的sql语句有一个查询，花费了8ms，在一众只花费0.01ms的查询中显得很诡异，于是我去查看该查询对应的代码。终于找到了GC的原因就在这里，如下图所示：

![image-20200812123056869](https://tva1.sinaimg.cn/large/007S8ZIlgy1ghnx3jfvr2j312s096ac0.jpg)

图中的代码功能是查询版权方信息，根据company_id查询copyright表中的记录，因为每个company_id对应公司的版权方信息都是一样的，所以我直接就取查到的第一个数据的版权信息。

乍一看没什么问题，但是这个查询查出来的数据量高达14w条，占在内存里GC不掉，于是就OOM了。

要解决就很简单，加个限制条件limit 1，sql语句查到数据返回就行了。

如下图所示

![image-20200815131012210](https://tva1.sinaimg.cn/large/007S8ZIlgy1ghrf3gqqjtj31180a40ut.jpg)